name: Build and Deploy Mobile Web

on:
  push:
    branches:
      - main
    paths:
      - 'apps/mobile/**'
      - '.github/workflows/build-mobile-web.yml'
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-northeast1
  SERVICE_NAME: expense-mobile-web

permissions:
  contents: write  # ãƒªãƒªãƒ¼ã‚¹ä½œæˆã«å¿…è¦
  id-token: write  # Google Cloudèªè¨¼ã«å¿…è¦

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current version and increment
        id: version
        run: |
          cd apps/mobile
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"
          
          IFS='.' read -ra VER <<< "$CURRENT_VERSION"
          PATCH=$((${VER[2]} + 1))
          NEW_VERSION="${VER[0]}.${VER[1]}.$PATCH"
          echo "New version: $NEW_VERSION"
          
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update version in package.json
        run: |
          cd apps/mobile
          npm version ${{ steps.version.outputs.new_version }} --no-git-tag-version

      - name: Update version in app.config.js
        run: |
          cd apps/mobile
          sed -i "s/version: '[^']*'/version: '${{ steps.version.outputs.new_version }}'/" app.config.js

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: apps/mobile/package-lock.json

      - name: Install dependencies
        working-directory: apps/mobile
        run: npm install --legacy-peer-deps

      - name: Build for Web
        working-directory: apps/mobile
        env:
          EXPO_PUBLIC_API_URL: ${{ secrets.EXPO_PUBLIC_API_URL }}
        run: |
          echo "Building mobile web app..."
          npx expo export --platform web --output-dir web-build
          
          echo "Build completed. Contents:"
          ls -la web-build/

      - name: Create Dockerfile for mobile web
        working-directory: apps/mobile
        run: |
          cat > Dockerfile << 'EOF'
          FROM node:20-alpine AS builder
          
          WORKDIR /app
          
          # Copy package files
          COPY package*.json ./
          COPY .npmrc ./
          
          # Install dependencies
          RUN npm install --legacy-peer-deps
          
          # Copy source files
          COPY . .
          
          # Build arguments for environment variables
          ARG EXPO_PUBLIC_API_URL
          ENV EXPO_PUBLIC_API_URL=$EXPO_PUBLIC_API_URL
          
          # Build for web using expo export
          RUN npx expo export --platform web --output-dir web-build
          
          # Production image
          FROM nginx:alpine
          
          # Copy built files from builder
          COPY --from=builder /app/web-build /usr/share/nginx/html
          
          # Create nginx config for SPA with proper MIME types
          RUN echo 'server { \
              listen 8080; \
              root /usr/share/nginx/html; \
              index index.html; \
              \
              # Proper MIME types \
              types { \
                  application/javascript js; \
                  text/css css; \
                  text/html html; \
                  image/png png; \
                  image/jpeg jpg; \
                  image/svg+xml svg; \
              } \
              \
              # SPA routing \
              location / { \
                  try_files $uri $uri/ /index.html; \
              } \
              \
              # Cache static assets \
              location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ { \
                  expires 1y; \
                  add_header Cache-Control "public, immutable"; \
              } \
          }' > /etc/nginx/conf.d/default.conf
          
          EXPOSE 8080
          CMD ["nginx", "-g", "daemon off;"]
          EOF
          
          cat Dockerfile

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and push Docker image
        working-directory: apps/mobile
        run: |
          IMAGE_NAME="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/expense-app/${{ env.SERVICE_NAME }}:${{ github.sha }}"
          IMAGE_TAG="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/expense-app/${{ env.SERVICE_NAME }}:v${{ steps.version.outputs.new_version }}"
          
          docker build \
            --build-arg EXPO_PUBLIC_API_URL=${{ secrets.EXPO_PUBLIC_API_URL }} \
            -t $IMAGE_NAME \
            -t $IMAGE_TAG \
            .
          docker push $IMAGE_NAME
          docker push $IMAGE_TAG
          
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ env.IMAGE_NAME }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --port 8080 \
            --memory 256Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10 \
            --timeout 60 \
            --project ${{ env.PROJECT_ID }}

      - name: Output service URL
        id: service_url
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          echo "Service URL: $SERVICE_URL"
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "service_url=$SERVICE_URL" >> $GITHUB_ENV

      - name: Create Release
        if: false  # ãƒªãƒªãƒ¼ã‚¹ä½œæˆã‚’ç„¡åŠ¹åŒ–
        uses: softprops/action-gh-release@v1
        with:
          tag_name: mobile-web-v${{ steps.version.outputs.new_version }}
          name: Mobile Web v${{ steps.version.outputs.new_version }}
          body: |
            ## Mobile Web version ${{ steps.version.outputs.new_version }}
            
            ### Build Information
            - **Platform**: Web (Mobile-optimized)
            - **Version**: ${{ steps.version.outputs.new_version }}
            - **Deployed to**: Google Cloud Run
            
            ### Access
            - **Service URL**: ${{ steps.service_url.outputs.SERVICE_URL }}
            
            ### Docker Image
            - `${{ env.IMAGE_NAME }}`
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Build and Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: Mobile Web" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Service URL**: [${{ env.service_url }}](${{ env.service_url }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Image**: \`${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ Access the application" >> $GITHUB_STEP_SUMMARY
          echo "Click here: [${{ env.service_url }}](${{ env.service_url }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“± QR Code" >> $GITHUB_STEP_SUMMARY
          echo "Scan this QR code with your mobile device:" >> $GITHUB_STEP_SUMMARY
          echo "![QR Code](https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${{ env.service_url }})" >> $GITHUB_STEP_SUMMARY
