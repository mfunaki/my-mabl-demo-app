name: Build iOS App

on:
  push:
    branches:
      - main
    paths:
      - 'apps/mobile/**'
      - '.github/workflows/build-mobile-ios.yml'
  workflow_dispatch:
    inputs:
      profile:
        description: 'EAS Build Profile'
        required: true
        default: 'simulator'
        type: choice
        options:
          - simulator

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current version and increment
        id: version
        run: |
          cd apps/mobile
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"
          
          IFS='.' read -ra VER <<< "$CURRENT_VERSION"
          MINOR=$((${VER[1]} + 1))
          NEW_VERSION="${VER[0]}.$MINOR"
          echo "New version: $NEW_VERSION"
          
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update version in package.json
        run: |
          cd apps/mobile
          npm version ${{ steps.version.outputs.new_version }} --no-git-tag-version

      - name: Update version in app.config.js
        run: |
          cd apps/mobile
          sed -i "s/version: '[^']*'/version: '${{ steps.version.outputs.new_version }}'/" app.config.js

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: apps/mobile/package-lock.json

      - name: Setup Expo and EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        working-directory: apps/mobile
        run: npm ci

      - name: Build iOS Simulator App
        id: build
        working-directory: apps/mobile
        env:
          EXPO_PUBLIC_API_URL: ${{ secrets.EXPO_PUBLIC_API_URL }}
        run: |
          eas build --platform ios \
            --profile simulator \
            --non-interactive \
            --json > build-output.json
          
          cat build-output.json
          BUILD_ID=$(jq -r '.[0].id // .id' build-output.json)
          echo "Build ID: $BUILD_ID"
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT

      - name: Wait for build completion
        id: wait
        working-directory: apps/mobile
        run: |
          BUILD_ID="${{ steps.build.outputs.build_id }}"
          echo "Waiting for build $BUILD_ID to complete..."
          
          MAX_WAIT=3600
          ELAPSED=0
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(eas build:view $BUILD_ID --json | jq -r '.status')
            echo "Build status: $STATUS (elapsed: ${ELAPSED}s)"
            
            if [ "$STATUS" = "FINISHED" ] || [ "$STATUS" = "finished" ]; then
              echo "Build completed successfully!"
              APP_URL=$(eas build:view $BUILD_ID --json | jq -r '.artifacts.buildUrl')
              echo "app_url=$APP_URL" >> $GITHUB_OUTPUT
              break
            elif [ "$STATUS" = "ERRORED" ] || [ "$STATUS" = "errored" ] || [ "$STATUS" = "CANCELED" ] || [ "$STATUS" = "canceled" ]; then
              echo "Build failed with status: $STATUS"
              exit 1
            fi
            
            sleep 30
            ELAPSED=$((ELAPSED + 30))
          done
          
          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "Build timeout after ${MAX_WAIT}s"
            exit 1
          fi

      - name: Download and extract APP file
        id: download
        working-directory: apps/mobile
        run: |
          APP_URL="${{ steps.wait.outputs.app_url }}"
          APP_ARCHIVE="expense-mobile-${{ steps.version.outputs.new_version }}.app.tar.gz"
          
          echo "Downloading APP archive from: $APP_URL"
          curl -L -o "$APP_ARCHIVE" "$APP_URL"
          
          echo "Extracting .app file..."
          tar -xzf "$APP_ARCHIVE"
          
          APP_PATH=$(find . -name "*.app" -type d | head -1)
          
          if [ -z "$APP_PATH" ]; then
            echo "Error: .app file not found after extraction"
            ls -la
            exit 1
          fi
          
          echo "Found APP file: $APP_PATH"
          
          APP_ZIP="expense-mobile-${{ steps.version.outputs.new_version }}.app.zip"
          zip -r "$APP_ZIP" "$APP_PATH"
          
          ls -lh "$APP_ZIP"
          echo "app_file=$APP_ZIP" >> $GITHUB_OUTPUT

      - name: Install mabl CLI
        run: |
          npm install -g @mablhq/mabl-cli
          mabl --version

      - name: Upload APP to mabl
        id: mabl_upload
        working-directory: apps/mobile
        env:
          MABL_API_KEY: ${{ secrets.MABL_API_KEY }}
        run: |
          echo "=== Checking APP file ==="
          ls -lh ${{ steps.download.outputs.app_file }}
          
          echo ""
          echo "=== Upload Configuration ==="
          echo "Version: ${{ steps.version.outputs.new_version }}"
          echo "File: ${{ steps.download.outputs.app_file }}"
          echo "Platform: iOS"
          
          echo ""
          echo "=== Starting Upload ==="
          set -x
          OUTPUT=$(mabl mobile-build-files upload \
            ${{ steps.download.outputs.app_file }} \
            --version ${{ steps.version.outputs.new_version }} \
            2>&1 | tee mabl-upload.log)
          
          UPLOAD_STATUS=${PIPESTATUS[0]}
          set +x
          
          echo ""
          echo "=== Upload Result ==="
          if [ $UPLOAD_STATUS -eq 0 ]; then
            echo "✅ Upload completed successfully!"
            
            BUILD_FILE_ID=$(echo "$OUTPUT" | grep -oE '[a-zA-Z0-9_-]+-maf' | tail -1)
            
            if [ -n "$BUILD_FILE_ID" ]; then
              echo "Build File ID: $BUILD_FILE_ID"
              echo "BUILD_FILE_ID=$BUILD_FILE_ID" >> $GITHUB_OUTPUT
              echo "BUILD_FILE_ID=$BUILD_FILE_ID" >> $GITHUB_ENV
            else
              echo "Warning: Could not extract Build File ID from output"
            fi
          else
            echo "❌ Upload failed with exit code: $UPLOAD_STATUS"
            cat mabl-upload.log
            exit $UPLOAD_STATUS
          fi

      - name: Create Release
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: mobile-ios-v${{ steps.version.outputs.new_version }}
          name: Mobile iOS v${{ steps.version.outputs.new_version }}
          body: |
            ## iOS App version ${{ steps.version.outputs.new_version }}
            
            ### Build Information
            - **Platform**: iOS (Simulator)
            - **Build Profile**: simulator
            - **Build ID**: ${{ steps.build.outputs.build_id }}
            - **Uploaded to mabl**: ✅
            - **mabl Build File ID**: ${{ steps.mabl_upload.outputs.BUILD_FILE_ID }}
            
            ### Download
            [View Build on Expo](https://expo.dev/accounts/${{ secrets.EXPO_USERNAME }}/projects/expense-mobile/builds/${{ steps.build.outputs.build_id }})
          draft: false
          prerelease: false
          files: apps/mobile/${{ steps.download.outputs.app_file }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload APP as artifact
        uses: actions/upload-artifact@v4
        with:
          name: expense-mobile-ios-${{ steps.version.outputs.new_version }}.app.zip
          path: apps/mobile/${{ steps.download.outputs.app_file }}
          retention-days: 30

      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: iOS (Simulator)" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build ID**: ${{ steps.build.outputs.build_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Profile**: simulator" >> $GITHUB_STEP_SUMMARY
          echo "- **APP File**: ${{ steps.download.outputs.app_file }}" >> $GITHUB_STEP_SUMMARY
          echo "- **mabl Build File ID**: ${{ steps.mabl_upload.outputs.BUILD_FILE_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build URL: https://expo.dev/accounts/${{ secrets.EXPO_USERNAME }}/projects/expense-mobile/builds/${{ steps.build.outputs.build_id }}" >> $GITHUB_STEP_SUMMARY
