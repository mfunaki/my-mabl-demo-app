# mabl Test Creation Agent用プロンプト: Mobileテスト

以下のMobileテストシナリオを作成してください。

## テスト対象アプリケーション

- **プラットフォーム**: React Native (Expo)
- **テスト対象デバイス**: iOS / Android
- **Mobile仕様書**: 添付の `spec-expense-app.md` セクション6「Mobile仕様」を参照
- **対象フレームワーク**: Expo + React Native

## テストの前提条件

### 事前準備
1. APIサーバーが起動していること
2. `POST /api/reset` で初期化済みであること（空の状態）
3. モバイルアプリが起動していること
4. Employee認証情報が利用可能であること: `employee` / `employee123`

## テストシナリオ: Employeeによる経費申請フロー

### テストの目的
- Employee ユーザーがログインできること
- 新規経費申請を作成できること
- 作成した申請が一覧に表示され、ステータスが「PENDING」であること
- Pull to Refresh で一覧を更新できること
- 申請のステータス変化（APPROVED）を確認できること

---

## テスト実行手順

### ステップ 1: アプリ起動とログイン画面の確認

**アクション**: アプリケーション起動

- **期待される画面**:
  - ログイン画面が表示されること
  - タイトル「経費申請アプリ」が表示されること（`testID="login-title"`）
  - サブタイトル「Employee Login」が表示されること

**検証項目**:
- ログイン画面が表示されていること
- ユーザー名入力フィールド（`testID="username-input"`）が表示されていること
- パスワード入力フィールド（`testID="password-input"`）が表示されていること
- ログインボタン（`testID="login-button"`）が表示されていること

---

### ステップ 2: Employee 認証情報でログイン

**アクション**: ログインフォームに入力・送信

- **入力フィールド**:
  - Username: `employee`
  - Password: `employee123`

- **実行内容**:
  1. ユーザー名フィールド（`testID="username-input"`）に `employee` を入力
  2. パスワードフィールド（`testID="password-input"`）に `employee123` を入力
  3. ログインボタン（`testID="login-button"`）をタップ

- **期待される動作**:
  - ログインが成功すること
  - ホーム画面（経費申請画面）に遷移すること
  - ログアウトボタン（`testID="logout-button"`）が表示されること

**検証項目**:
- ホーム画面が表示されていること
- ヘッダーに「経費申請」というタイトルが表示されていること
- 「新規申請」フォームが表示されていること
- 「申請履歴」セクションが表示されていること
- エラーメッセージが表示されていないこと

---

### ステップ 3: 空の申請リストを確認

**アクション**: 初期状態の申請履歴を確認

- **検証項目**:
  - 「申請履歴 (0件)」と表示されていること
  - 空のメッセージ「申請データがありません」（`testID="empty-message"`）が表示されていること
  - 申請アイテムが表示されていないこと

---

### ステップ 4: 新規経費申請を作成（Conference）

**アクション**: 経費申請フォームに入力・送信

- **入力フィールド**:
  - タイトル: `Conference`
  - 金額: `1000`

- **実行内容**:
  1. タイトル入力フィールド（`testID="title-input"`）に `Conference` を入力
  2. 金額入力フィールド（`testID="amount-input"`）に `1000` を入力
  3. 申請ボタン（`testID="submit-button"`）をタップ

- **期待される動作**:
  - 申請が成功すること
  - 成功アラート「成功 - 経費を申請しました」が表示されること
  - フォームがクリアされること（タイトルと金額が空になる）
  - 申請履歴に新しい申請が自動的に追加されること

**検証項目**:
- 成功アラートが表示されること
- アラートを閉じた後、フォームが空になっていること
- 申請履歴カウントが「申請履歴 (1件)」に更新されていること

---

### ステップ 5: 申請リストの確認（Conference - PENDING）

**アクション**: 作成した申請が一覧に表示されることを確認

- **検証対象**:
  - 申請アイテム（`testID="expense-item-Conference"`）

- **期待される内容**:
  - **タイトル**: `Conference`（`testID="expense-title-{id}"`）
  - **金額**: `¥1,000`（`testID="expense-amount-{id}"`）
  - **ステータス**: `PENDING`（`testID="expense-status-{id}"`）
    - ステータスバッジの背景色がオレンジ色（`#FF9500`）であること

**検証項目**:
- Conference の申請アイテムが表示されていること
- タイトルが「Conference」であること
- 金額が「¥1,000」であること
- ステータスが「PENDING」であること
- ステータスバッジの色がオレンジ色であること
- 作成日時が表示されていること

**補足**: `testID` はタイトルベース（`expense-item-Conference`）とIDベース（`expense-title-{id}`など）の2種類があります。タイトルベースのIDでアイテム全体を特定し、IDベースのIDで個別の要素を検証してください。

---

### ステップ 6: Pull to Refresh で一覧を更新

**アクション**: リストを下にスワイプしてリフレッシュ

- **実行内容**:
  1. 申請履歴リストを上から下にスワイプ（Pull to Refresh）
  2. リフレッシュコントロール（`testID="refresh-control"`）が表示されることを確認
  3. リフレッシュが完了するまで待機

- **期待される動作**:
  - リフレッシュインジケータが表示されること
  - リフレッシュ完了後、最新のデータが表示されること
  - Conference の申請が引き続き表示されていること

**検証項目**:
- リフレッシュが正常に動作すること
- Conference の申請が引き続き表示されていること
- ステータスが「PENDING」のままであること（この時点では未承認）

---

### ステップ 7: ステータス更新の確認（外部操作後）

**注意**: このステップは、Web管理画面でManager がConference の申請を承認した後に実行します。

**アクション**: Pull to Refresh でステータス更新を確認

- **前提条件**:
  - Web管理画面で Manager が Conference の申請を承認済みであること（ステータスが `APPROVED` に変更されている）

- **実行内容**:
  1. 申請履歴リストを上から下にスワイプ（Pull to Refresh）
  2. リフレッシュが完了するまで待機
  3. Conference の申請のステータスを確認

- **期待される動作**:
  - ステータスが「PENDING」から「APPROVED」に変わっていること
  - ステータスバッジの背景色が緑色（`#34C759`）に変わっていること

**検証項目**:
- Conference の申請が引き続き表示されていること
- タイトルが「Conference」であること
- 金額が「¥1,000」であること
- ステータスが「APPROVED」に変わっていること
- ステータスバッジの色が緑色に変わっていること

---

### ステップ 8: ログアウト（オプション）

**アクション**: ログアウト機能の確認

- **実行内容**:
  1. ログアウトボタン（`testID="logout-button"`）をタップ
  2. ログイン画面にリダイレクトされることを確認

- **期待される動作**:
  - ユーザーセッションがクリアされること
  - ログイン画面が表示されること

**検証項目**:
- ログアウト後、ログイン画面が表示されていること
- ログインフォームが空の状態であること

---

## 検証ポイント（UI要素の確認）

以下の検証は各ステップ完了後に確認してください：

### 画面要素の検証

| 要素 | testID | 期待値 | 検証方法 |
|------|--------|--------|---------|
| ログインタイトル | `login-title` | 「経費申請アプリ」 | テキスト内容を確認 |
| ユーザー名入力 | `username-input` | 入力可能 | 要素が存在し、入力可能であること |
| パスワード入力 | `password-input` | 入力可能 | 要素が存在し、入力可能であること |
| ログインボタン | `login-button` | タップ可能 | 要素が存在し、`disabled` でないこと |
| タイトル入力 | `title-input` | 入力可能 | 要素が存在し、入力可能であること |
| 金額入力 | `amount-input` | 数値入力可能 | 要素が存在し、数値キーボードが表示されること |
| 申請ボタン | `submit-button` | タップ可能 | 要素が存在し、`disabled` でないこと |
| 空メッセージ | `empty-message` | 「申請データがありません」 | データがない場合に表示されること |
| 申請アイテム | `expense-item-Conference` | 存在する | Conference の申請が表示されること |
| ステータスバッジ | `expense-status-{id}` | 「PENDING」→「APPROVED」 | テキストと背景色を確認 |
| ログアウトボタン | `logout-button` | タップ可能 | 要素が存在し、タップ可能であること |

### ステータスバッジの色検証

| ステータス | 表示テキスト | 背景色 | HEXコード |
|----------|------------|-------|----------|
| PENDING | PENDING | オレンジ | `#FF9500` |
| APPROVED | APPROVED | 緑 | `#34C759` |
| REJECTED | REJECTED | 赤 | `#FF3B30` |

### API 連携の検証

- **ログイン時の API呼び出し**:
  - バックエンド認証が成功していること
  - AsyncStorage にユーザー名が保存されること

- **申請作成時の API呼び出し**:
  - エンドポイント: `POST /api/expenses`
  - リクエストヘッダー: `Authorization: employee`
  - リクエストボディ: `{"title": "Conference", "amount": 1000}`
  - レスポンス: HTTP 201

- **一覧取得時の API呼び出し**:
  - エンドポイント: `GET /api/expenses`
  - リクエストヘッダー: `Authorization: employee`
  - レスポンス: HTTP 200、申請の配列

---

## テスト全体の成功条件

上記の全てのステップが正常に完了し、以下の状態になっていること:

1. ✅ Employee としてログインできる
2. ✅ 空の申請リストが表示される
3. ✅ Conference（1000円）の経費申請を作成できる
4. ✅ 作成した申請が一覧に表示され、ステータスが「PENDING」である
5. ✅ Pull to Refresh でリストを更新できる
6. ✅ Manager による承認後、ステータスが「APPROVED」に更新される
7. ✅ ログアウトが正常に機能する

---

## 環境変数・設定

モバイルアプリの環境変数設定：

```bash
# apps/mobile/.env
EXPO_PUBLIC_API_URL=https://expense-app-api-xxxxx.run.app
# または、ローカル環境の場合
EXPO_PUBLIC_API_URL=http://localhost:4000
```

**注意**: ローカルネットワークでテストする場合、APIサーバーのIPアドレスを使用してください（例: `http://192.168.1.100:4000`）。`localhost` はモバイルデバイス自身を指すため、物理デバイスやエミュレーターからは接続できません。

---

## トラブルシューティング

### よくあるエラー

| エラー | 原因 | 対処法 |
|--------|------|--------|
| ログインボタンが無効状態 | 入力フィールドが空 | Username と Password を確認 |
| 「ネットワークエラー」アラート | APIサーバーに接続できない | APIサーバーの起動状態とURL設定を確認 |
| 申請作成後も空のまま | API呼び出しが失敗している | ネットワークタブまたはコンソールでエラーを確認 |
| Pull to Refresh が動作しない | リストが空またはスクロール不可 | データが存在することを確認 |
| ステータスが更新されない | リフレッシュされていない | 手動でPull to Refresh を実行 |
| CORS エラー | `CORS_ORIGIN` 未設定 | APIサーバーの環境変数 `CORS_ORIGIN` を確認 |
| 物理デバイスで接続できない | localhost を使用している | IPアドレス（例: 192.168.1.100）を使用 |

### デバッグモード（開発時のみ）

開発モードでは、画面下部に「Test API Connection」ボタンが表示されます。このボタンをタップすると、API接続テストが実行され、以下の情報が表示されます：

- API URL
- プラットフォーム（iOS/Android）
- 接続ステータス
- レスポンス内容

---

## 参考資料

- **API テスト**: `/docs/prompts/11-api-test.md`
- **Web テスト**: `/docs/prompts/12-web-test.md`
- **Mobile 仕様**: `/docs/spec-expense-app.md` セクション6
- **総仕様書**: `/docs/spec-expense-app.md`
- **mabl 生成指示**: `/docs/prompts/04-mabl-generation.md`

---

## 追加のテストシナリオ（オプション）

### シナリオ A: 複数申請の作成

1. Conference（1000円）を作成
2. Taxi（500円）を作成
3. Lunch（1500円）を作成
4. 申請履歴が「申請履歴 (3件)」と表示されることを確認
5. 各申請のステータスが「PENDING」であることを確認

### シナリオ B: 承認と却下の混在

1. Conference（1000円）を作成
2. Taxi（500円）を作成
3. Web管理画面で Conference を承認（APPROVED）
4. Web管理画面で Taxi を却下（REJECTED）
5. モバイルアプリでリフレッシュ
6. Conference のステータスが「APPROVED」（緑）であることを確認
7. Taxi のステータスが「REJECTED」（赤）であることを確認

### シナリオ C: バリデーションエラー

1. タイトルを空のまま申請ボタンをタップ
2. エラーアラート「エラー - タイトルと金額を入力してください」が表示されることを確認
3. 金額を空のまま申請ボタンをタップ
4. 同様のエラーアラートが表示されることを確認

---

## 注意事項

- 各ステップは順番に実行してください（前のステップが成功した場合のみ次に進む）
- 認証は Authorization ヘッダーでユーザー名（`employee`）を渡します
- JWT トークンなどの認証トークンは不要です（簡易認証）
- テスト実行前に必ずデータリセットを行ってください（`POST /api/reset`）
- テスト実行環境の API URL は実際のデプロイ先に合わせて変更してください
- モバイルテストでは、`testID` と `accessibilityLabel` の両方が設定されています。テストツールに応じて適切な方を使用してください
- React Native では、Android と iOS で一部の動作が異なる場合があります。可能であれば両方のプラットフォームでテストしてください
