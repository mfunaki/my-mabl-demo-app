# テスト設計改善レポート作成プロンプト

## 概要

mablテストのCSVファイル（テストステップ定義）を分析し、テスト設計・構成に関する改善提案レポートを作成するためのプロンプトです。

## 入力ファイル

### テストステップCSV

`/tests/steps/` ディレクトリ配下のCSVファイルを参照します。

```
/tests/steps/
├── login-dashboard-navigation.csv
├── manager-expense-approval-flow.csv
├── manager-login.csv
└── （その他のテストステップCSV）
```

### CSVファイルの形式

```csv
step_number,action,target,value,context
1,Set viewport size,viewport,"width: 1080, height: 1440",Confirm Manager Login Page and Credentials
2,Visit URL,app.url,-,Navigates to the application's URL
3,Echo,-,--> Navigate to the Login Page,Log message
4,Assert innerText,<div> element,経費管理 - Manager Login,Asserts manager login page is displayed
...
```

| 列 | 説明 |
|----|------|
| step_number | ステップ番号 |
| action | ステップの種類（Click, Input, Assert, Echo, Set variable等） |
| target | 操作対象（要素、変数名等） |
| value | 入力値、期待値など |
| context | ステップの説明・目的 |

## 出力ファイル

`/tests/reports/test_design_improvement_report.md`

## プロンプト

以下のプロンプトを使用して、テスト設計改善レポートを作成してください。

---

### プロンプト本文

```
/tests/steps/ ディレクトリ配下にあるテストステップCSVファイルを分析し、
テスト設計・構成に関する改善提案レポートを作成してください。

## レポート構成

### 1. エグゼクティブ・サマリー（最初に記載）

経営層・マネージャー向けに、以下の内容を簡潔にまとめてください：

#### 1.1 現状評価
- テスト資産の全体評価（成熟度レベル: 初期/発展中/成熟/最適化）
- 主要な強み（3点）
- 主要な課題（3点）
- 品質リスク評価（高/中/低）

#### 1.2 目指すべき姿（ビジョン）
- 「問題を早期に発見し、ユーザー影響を最小化するテスト体制」
- 具体的な到達イメージ（テスト実行時間、カバレッジ、安定性等）

#### 1.3 ロードマップ（改善の時間軸）

| 期間 | 目標 | 主なアクション | 期待効果 |
|------|------|--------------|---------|
| **即時（今週中）** | クイックウィン | 不要ステップ削除、固定Wait最適化 | テスト実行時間10-20%短縮 |
| **1ヶ月** | 基盤整備 | 共通FlowのKure化、命名規約統一 | 保守工数30%削減、新規テスト作成効率向上 |
| **3ヶ月** | 安定性向上 | セレクタ改善、動的待機への移行 | テスト成功率95%以上、フレーキーテスト解消 |
| **6ヶ月** | カバレッジ拡大 | アサーション強化、エラーケース追加 | リグレッション検出率向上、本番障害の事前検出 |
| **1年** | 最適化完了 | CI/CD完全統合、自動メンテナンス | デプロイ頻度向上、リリースサイクル短縮 |

#### 1.4 優先度マトリクス（何から着手すべきか）

```
            高い効果
               ↑
    ┌──────────┼──────────┐
    │ 優先度2  │ 優先度1   │
    │ (計画的) │ (即実行)  │
    ├──────────┼──────────┤
    │ 優先度4  │ 優先度3   │
    │ (様子見) │ (余裕時)  │
    └──────────┴──────────┘
    低い工数 ←─────────→ 高い工数
```

以下の観点で各改善項目を分類：
- **優先度1（即実行）**: 工数が低く効果が高い → 今すぐ着手
- **優先度2（計画的）**: 工数は高いが効果も高い → 計画を立てて実行
- **優先度3（余裕時）**: 工数が低いが効果も低い → 余裕があれば実施
- **優先度4（様子見）**: 工数が高く効果が低い → 優先度を下げる

#### 1.5 ビジネスインパクト

改善によりサービス品質向上にどう貢献するか：
- **問題の早期発見**: リリース前に検出できる不具合の増加
- **修正コストの削減**: 開発段階での発見 vs 本番での発見のコスト比較
- **ユーザー影響の最小化**: 本番障害の未然防止件数
- **開発速度の向上**: 安定したテストによる自信を持ったリリース

### 2. 良い点の評価（Good Practices）

**重要**: 改善点だけでなく、良い点も積極的に評価してください。
良い実践を認識し称賛することで、チームのモチベーション向上と
ベストプラクティスの継続・共有につながります。

### 3. 詳細分析と改善提案

分析観点：

0. **良い点の評価（Good Practices）** ★最初に記載★
   以下の観点で優れている点を見つけ、具体的に称賛してください：
   - 命名規約が統一されている箇所
   - 適切にFlow化されている共通処理
   - WaitUntilを使用した動的待機
   - data-testidやaria属性を活用した安定したセレクタ
   - 変数を適切に活用したテストデータ管理
   - Echo文による分かりやすいドキュメント化
   - 適切なアサーションの配置
   - ステップ数が適切に抑えられているテスト
   - IF文を使った柔軟なエラーハンドリング
   - 環境変数を活用した環境依存データの分離

   **評価の書き方例**:
   - 「✨ manager-expense-approval-flowでは、ログイン処理がFlowとして適切に共通化されています」
   - 「✨ data-testid属性を使用したセレクタが多く、テストの安定性が高いです」
   - 「✨ Echo文で処理の区切りが明確に示されており、デバッグ時に追跡しやすい構成です」

1. **テスト名・ファイル名の命名規約**
   - 命名規則の一貫性（プレフィックス、連番、区切り文字）
   - テスト内容を適切に表現しているか
   - 日本語/英語の混在
   - 長すぎる/短すぎる名前
   - 推奨命名規約の提案
   - **mabl推奨**: `<アプリ名> - <モジュール/機能> - <説明>` 形式
   - **運用事例**: `<チーム名>-<サービス名>-<テスト対象機能>-<実施操作>` 形式（複数チーム環境向け）
   - テスト説明（description）フィールドの活用

2. **共通処理のReusable Flow化**
   - 複数テストで重複している処理（ログイン、ナビゲーション、ログアウト等）
   - IF文によるリトライ処理
   - 環境分岐処理（dev/stg）
   - **mabl推奨**: Flowは1つの目的に集中させる（例: 経費申請と経費承認を分離）
   - **Over-Flowingの回避**: 再利用されないFlowを作らない
   - 既存Flowの確認: 新規作成前に既存Flowをチェック
   - Flow命名規約: `(順番) タイプ - アプリ - アクション (パラメータ) (=> 出力)`
   - **運用事例**: 画面パスを接頭辞として付与、画面名は『』で囲う、画面上の文言は""で囲う
   - Flowパラメータの活用: 変数のスコープ制限と再利用性向上
   - **基本方針**: 「テストはフローで構成する」- 既存フローを組み合わせて効率的に実装

3. **待機処理の最適化**
   - 固定Wait（Wait for X seconds）の使用箇所と合計時間
   - WaitUntilへの置き換え可能性
   - 適切な待機条件の提案
   - **mabl推奨**: Intelligent Waitを活用し、固定Waitは最小限に
   - Wait Untilステップ（動的待機）を優先使用

4. **セレクタの改善**
   - 曖昧なセレクタ（"that meets the selected criteria"等）
   - CSSモジュールのハッシュ値依存
   - data-testid、aria属性の活用提案
   - **mabl推奨**: 要素検索に時間がかかる場合はConfigure Findで追加コンテキストを設定

5. **テスト構造の見直し**
   - テストの粒度（ステップ数の適正化）
     - mablの警告基準: 500ステップ以上で警告
     - 推奨: 100ステップ程度（Flowで折りたたんだ状態で）
     - Flowを活用して複数ステップを論理的にグループ化
   - IF文のネスト深さ
   - 重複するアサーション
   - テストの独立性（他テストへの依存）
   - **mabl推奨**: 1テスト1目的（複数シナリオを1テストに詰め込まない）
   - **mabl推奨**: 各テストは独立して実行可能に（テスト開始時に自身のテストデータをセットアップ）
   - 並列実行時の競合を避ける設計

6. **アサーションの追加提案**
   - 不足している検証項目
   - エラーケーステスト
   - バリデーションテストの充実
   - 境界値テスト
   - **mabl推奨**: アサーションの厳密さのバランス
     - 厳密すぎる: 重要でない変更でテスト失敗
     - 緩すぎる: リグレッションを見逃す
   - **mabl推奨**: スモークテストでは重要な要素のみ検証
   - URLアサーション: ends with等で過度な厳密さを避ける
   - 変数を使用したコンテキストベースのアサーション

7. **テストデータの管理**
   - ハードコードされたテストデータ
   - 変数・Data Tableの活用状況
   - 環境依存データの分離
   - **変数の適切な使用（入力値とアサーション値の一貫性）**
     - 入力値を変数に設定 → 入力フィールドに変数を使用 → アサーションで同じ変数と比較
     - 例: 変数expense_titleに"Taxi"を設定 → 入力 → 表示値をexpense_titleと比較
   - **運用事例**: Flow内の変数利用時はパラメーター経由で渡す（環境変数の直接利用・上書きを避ける）
   - 同名変数による意図しない上書き防止

8. **ドキュメント化の改善**
   - context列の活用状況
   - Echo文のフォーマットと一貫性
     - レベル分け（#, ##, ###）による階層構造
     - セクション/サブセクション/ステップの可視化
   - テストの目的・前提条件の明記
   - **運用事例**: テストケース内に適切なコメント（Echo）を挿入し、実行内容に応じた結果確認を明記

9. **保守性・可読性**
   - ステップの論理的なグループ化
   - マジックナンバーの使用
   - 意図が不明確なステップ

10. **実行効率**
    - 不要なステップの削除
      - **レコーディング時に記録された不要なClickステップ**
        - テキストボックスへのClick後すぐにInputがある場合、Clickは不要
        - ただし、Clickの直後にHover等のアサーションがある場合は必要
      - 重複する操作の削除
      - **mabl推奨**: 不要なHoverアクションの削除（大量の隠しデータが記録される）
    - 並列実行の可能性
    - テストの実行順序の最適化
    - **mabl推奨**: 最も遅いテストを最適化することでプラン全体の実行時間を短縮
    - **運用事例**: 1日に複数回実行可能な設計を目指す

11. **レビュープロセス**
    - テストケース作成者による自己チェック
    - チーム内レビューの実施
    - ブランチ機能を活用した並行作業体制
    - **運用事例**: ブランチ名は「テスト管理番号 + 作業者名」で命名（誰が何の作業をしているか明確化）

出力形式：
- スライド形式のマークダウン（---で区切り）
- **最初にエグゼクティブ・サマリー**（経営層向け: 現状、ビジョン、ロードマップ、優先度）
- **2番目に「良い点（Good Practices）」を紹介**（モチベーション向上のため）
- 優先度マトリクスに基づくアクションアイテム（優先度1→2→3→4の順）
- 具体的なコード例（現状 vs 推奨）
- **ビジネスインパクト**: 問題の早期発見・修正コスト削減・ユーザー影響最小化への貢献
- チェックリスト形式のサマリー
- **良い点と改善点のバランス**: 改善点だけでなく、チームの努力を認める内容を含める

出力先：/tests/reports/test_design_improvement_report.md
```

---

## 分析のポイント

### エグゼクティブ・サマリーの作成ガイド

レポートの冒頭に、経営層・マネージャーが意思決定できる情報を簡潔にまとめます。

#### 成熟度レベルの判定基準

| レベル | 基準 | 特徴 |
|--------|------|------|
| **初期** | テスト自動化を始めたばかり | Flow未活用、固定Wait多用、命名規約なし |
| **発展中** | 基本的な自動化が機能 | 一部Flow化、命名規約が部分的に統一 |
| **成熟** | 効率的なテスト運用 | 共通Flow活用、動的待機、安定したセレクタ |
| **最適化** | 継続的な改善サイクル | CI/CD統合、自動メンテナンス、高カバレッジ |

#### 優先度マトリクスへの分類例

| 改善項目 | 工数 | 効果 | 優先度 | 理由 |
|---------|------|------|--------|------|
| 不要なClickステップ削除 | 低 | 中 | 1 | 即座に実行可能、テスト時間短縮 |
| 固定Wait→WaitUntil置換 | 中 | 高 | 1 | テスト安定性向上に直結 |
| 共通処理のFlow化 | 高 | 高 | 2 | 計画的に進めるが効果大 |
| data-testid追加 | 高 | 高 | 2 | 開発チームとの連携が必要 |
| Echo文のレベル分け | 低 | 低 | 3 | 余裕があれば実施 |
| 全テストの命名規約統一 | 中 | 低 | 4 | 既存テストへの影響大 |

#### ビジネスインパクトの記載例

```
## サービス品質への貢献

### 問題の早期発見
- 現状: リリース後に発見される不具合が月平均X件
- 改善後: テスト強化によりリリース前に80%を検出可能に
- 効果: 本番障害対応コスト削減、ユーザー信頼性向上

### 修正コストの削減
- 開発段階での不具合修正: 1件あたり約2時間
- 本番での不具合修正: 1件あたり約16時間（調査・対応・報告含む）
- 効果: 早期発見により修正コストを1/8に削減

### 開発速度の向上
- 現状: テストの不安定さにより再実行が頻発
- 改善後: テスト成功率95%以上で安定したCI/CDパイプライン
- 効果: リリースサイクルの短縮、開発者の生産性向上
```

### 0. 良い点の評価（Good Practices）

レポートの最初に、テストの良い点を具体的に称賛するセクションを設けます。

#### 評価観点と記載例

| 観点 | 良い点の例 |
|------|-----------|
| 命名規約 | ✨ すべてのテストで `mabl-expense` または機能名がプレフィックスとして統一されており、識別しやすい |
| Flow活用 | ✨ ログイン処理が共通Flowとして実装されており、保守性が高い |
| 待機処理 | ✨ WaitUntilを使用して動的に要素を待機しており、テストの安定性が高い |
| セレクタ | ✨ data-testid属性を積極的に活用しており、UI変更に強い設計 |
| 変数管理 | ✨ 環境変数（app.url等）を活用して環境依存を分離できている |
| ドキュメント | ✨ Echo文で各セクションの開始が明示されており、ログが追いやすい |
| アサーション | ✨ 重要な画面遷移後に適切なアサーションが配置されている |
| エラー処理 | ✨ IF文を使用してポップアップの有無を柔軟に処理している |

#### 記載のポイント

```
# 良い点を書く際のガイドライン

1. 具体的なテスト名やステップ番号を挙げる
   ✅ 「manager-expense-approval-flowのStep 4では、Assert innerTextでページタイトルを検証しています」
   ❌ 「アサーションがうまくできています」（抽象的すぎる）

2. なぜ良いのかを説明する
   ✅ 「data-testidを使用しているため、CSSクラス名が変わってもテストが壊れにくい」
   ❌ 「data-testidを使っています」（理由がない）

3. チーム全体で共有すべきパターンとして紹介する
   ✅ 「このパターンは他のテストでも参考にできる良い実践です」
```

### 1. テスト名・ファイル名の命名規約

```
# 現状の命名パターン分析
login-dashboard-navigation         → {機能}-{遷移先}形式
manager-expense-approval-flow      → {ロール}-{機能}-{フロー種別}形式
manager-login                      → {ロール}-{機能}形式

# チェックポイント
- プレフィックスの一貫性（mabl-expense, manager_, employee_等）
- 区切り文字（ハイフン統一）
- 機能名の粒度（具体的すぎ/抽象的すぎ）
- 日本語の使用可否
```

**推奨命名規約例**:
```
{アプリ}_{ロール}_{画面/機能}_{シナリオ}
例: mabl-expense_manager_dashboard_approve-expense
例: mabl-expense_employee_mobile_submit-expense
```

### 2. 共通処理の検出

以下のパターンを複数テストで検索：

```
# ログイン処理パターン
Visit URL,app.url
Input,username-input,manager
Input,password-input,manager123
Click,login-button
Assert,header,経費承認ダッシュボード
```

```
# 経費承認処理パターン
Click,承認 button
Assert innerText,<table> element,APPROVED
```

### 3. 固定Waitの検出

```
# 検索パターン
action = "Wait"
value contains "seconds"
```

### 4. 曖昧なセレクタの検出

```
# 検索パターン
target contains "that meets the selected criteria"
target contains "<svg> element"
target contains "first <a> element"（インデックス依存）
```

### 5. テストデータのハードコード検出

```
# 検索パターン
value = "manager"（ユーザー名直書き）
value = "manager123"（パスワード直書き）
value = "1500"（金額直書き）
Assert ... equals "固定値"
```

### 5-2. 変数の適切な使用パターン

#### 問題のあるパターン（入力値とアサーション値が別々にハードコード）

```
❌ 現状（問題あり）
Step 6: Set variable, taxi_expense_id, 2
Step 7: Click, 承認 button
Step 8: Assert innerText, <table> element, Taxi employee ¥1,500 APPROVED
```

**問題点**:
- "Taxi"や"1,500"を変更する場合、アサーションの修正が必要
- 入力値とアサーション値の不一致リスク

#### 推奨パターン（変数で一元管理）

```
✅ 推奨（変数を使用）
Step 5: Set variable, expense_title, Taxi
Step 6: Set variable, expense_amount, 1500
Step 7: Click, 承認 button
Step 8: Assert innerText, Contains value of variable "expense_title" and "APPROVED"
```

**メリット**:
- テストデータの変更が1箇所で済む
- 入力値とアサーション値の一貫性が保証される
- Data Tableと組み合わせてデータ駆動テストに発展可能

### 5-3. 不要なClickステップの検出

#### 問題のあるパターン（レコーディング時の余分なClick）

```
❌ 現状（不要なステップあり）
Step 2: Click, username-input                    ← 不要
Step 3: Input, username-input, manager
Step 4: Click, password-input                    ← 不要
Step 5: Input, password-input, manager123
```

**問題点**:
- レコーディング時にテキストボックスをクリックした操作が記録される
- Inputステップは自動的に対象フィールドにフォーカスするため、Clickは不要
- ステップ数が無駄に増加

#### 推奨パターン（不要なClickを削除）

```
✅ 推奨（Clickを削除）
Step 2: Input, username-input, manager
Step 3: Input, password-input, manager123
```

#### Clickが必要なケース

```
# 以下の場合はClickを残す
- Click直後にHover、Assert等でフォーカス状態を検証する場合
- ドロップダウンを開く操作（Click → Select）
- ボタンのクリック（Click, login-button）
- 明示的なフォーカス移動が必要な場合
```

### 6. テストの複雑度評価

#### ステップ数の基準

| ステップ数 | 判定 | 説明 |
|-----------|------|------|
| 100以下 | ✅ 適切 | 理想的なテストサイズ |
| 100-200 | 🟡 要検討 | Flowによるグループ化を検討 |
| 200-500 | 🟠 要改善 | テスト分割またはFlow化が必要 |
| 500以上 | 🔴 警告 | **mablが警告を出す基準**。必ず分割が必要 |

**推奨**: Flowで折りたたんだ状態で約100ステップに見えるように構成

#### IF文のネスト

| ネスト深さ | 判定 |
|-----------|------|
| 2段階以下 | ✅ 適切 |
| 3段階 | 🟡 要検討 |
| 4段階以上 | 🔴 要改善 |

#### 固定Wait合計

| 合計時間 | 判定 |
|---------|------|
| 15秒以下 | ✅ 適切 |
| 15-30秒 | 🟡 要検討 |
| 30秒以上 | 🔴 最適化必要 |

### 7. Echo文のフォーマット分析

```
# 現状のパターン（経費管理アプリの例）
Echo: "--> Navigate to the Login Page"
Echo: "--> Log in as a Manager User"
Echo: "--> Confirm 'Taxi' Application Status Update to 'APPROVED'"
```

#### 推奨フォーマット（レベル分け）

```
# レベル1: テスト全体のセクション（#）
Echo: "# 1. ログイン処理"
Echo: "# 2. 経費一覧表示"
Echo: "# 3. 経費承認"

# レベル2: サブセクション（##）
Echo: "## 1.1 ユーザー名入力"
Echo: "## 1.2 パスワード入力"
Echo: "## 2.1 PENDING状態の経費確認"

# レベル3: 詳細ステップ（###）
Echo: "### 承認ボタンクリック"
Echo: "### APPROVED状態への変更確認"
```

#### タグ付きフォーマット（代替案）

```
Echo: "[SECTION] 1. ログイン処理"
Echo: "[STEP] 1.1 ユーザー名入力"
Echo: "[VERIFY] 1.2 ダッシュボード表示確認"
Echo: "[ACTION] 経費承認"
Echo: "[START] 経費承認フロー"
Echo: "[END] 経費承認フロー"
```

#### 期待効果

- mabl UIでのログ表示時に階層構造が視認しやすい
- テスト失敗時のデバッグが容易
- テストの流れが一目で把握できる

## 使用例

```bash
# Claude Codeでの実行例
claude "
/tests/steps/ ディレクトリ配下にあるテストステップCSVファイルを分析し、
テスト設計・構成に関する改善提案をまとめてください。
出力先は /tests/reports/test_design_improvement_report.md です。
"
```

## チェックリスト

レポート作成時に以下の項目を確認：

### エグゼクティブ・サマリー（最重要）
- [ ] 成熟度レベルを判定したか（初期/発展中/成熟/最適化）
- [ ] 主要な強み3点と課題3点を記載したか
- [ ] ロードマップ（即時/1ヶ月/3ヶ月/6ヶ月/1年）を作成したか
- [ ] 優先度マトリクスで改善項目を分類したか
- [ ] ビジネスインパクト（問題の早期発見、修正コスト削減、ユーザー影響最小化）を記載したか

### 良い点の評価
- [ ] 良い点を具体的に記載したか
- [ ] テスト名やステップ番号を挙げて称賛したか
- [ ] なぜ良いのか理由を説明したか
- [ ] チームで共有すべきパターンとして紹介したか

### 命名規約
- [ ] テスト名の命名規則が統一されているか
- [ ] テスト内容が名前から推測できるか
- [ ] 連番が適切に管理されているか

### 構造
- [ ] 共通処理がFlow化されているか
- [ ] ステップ数が500未満か（mabl警告基準）
- [ ] Flowで折りたたんだ状態で100ステップ程度か
- [ ] IF文のネストが深すぎないか（3段階以下）

### 待機処理
- [ ] 固定Waitが多用されていないか
- [ ] WaitUntilで置き換え可能か

### セレクタ
- [ ] 曖昧なセレクタがないか
- [ ] data-testidが活用されているか

### テストデータ
- [ ] ハードコードされたデータがないか
- [ ] 環境依存データが分離されているか
- [ ] 入力値とアサーション値が同じ変数を参照しているか
- [ ] 変数名が意味のある名前になっているか

### 実行効率
- [ ] テキストフィールドへの不要なClickがないか
- [ ] 重複する操作がないか

### ドキュメント
- [ ] context列が適切に記載されているか
- [ ] Echo文でテストの流れが追えるか
- [ ] Echo文がレベル分け（#, ##, ###）されているか

### レビュープロセス
- [ ] 作成者による自己チェックが完了しているか
- [ ] チーム内レビューを実施したか
- [ ] ブランチ名が命名規約に従っているか（テスト管理番号 + 作業者名）

## 関連ファイル

- 出力レポート: `/tests/reports/test_design_improvement_report.md`
- APIエラー分析プロンプト: `/tests/prompts/api_error_analysis_prompt.md`（別途作成）
- テスト一覧: `/tests/tests_in_mabl_expense.csv`

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-01-16 | 初版作成 |
| 2025-01-16 | 命名規約、テストデータ管理、保守性・可読性、実行効率の観点を追加 |
| 2025-01-16 | ステップ数基準を詳細化（mabl警告基準500、推奨100）、Echo文のレベル分け（#, ##, ###）を追加 |
| 2025-01-16 | 変数の適切な使用（入力値とアサーション値の一貫性）、不要なClickステップの削除を追加 |
| 2025-01-16 | mabl公式ベストプラクティス（命名規約、Flow設計、待機処理、セレクタ、テスト構造、アサーション、実行効率）を追加 |
| 2025-01-16 | 運用事例（hacomono/エムスリー）を追加: チーム命名規約、Flow命名、変数管理、レビュープロセス |
| 2025-01-16 | 良い点の評価（Good Practices）セクションを追加: モチベーション向上のため改善点だけでなく良い点も称賛 |
| 2025-01-16 | エグゼクティブ・サマリーを追加: 現状評価、ビジョン、ロードマップ（即時〜1年）、優先度マトリクス、ビジネスインパクト |
| 2026-01-28 | mabl-expense（経費管理アプリ）プロジェクト向けに更新: CSVフォーマット、テスト名、具体例を変更 |
